<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAI Studio - Professional Editor (Full Version)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: { 
                            dark: '#09090b',    /* 앱 전체 배경 (Zinc-950) */
                            panel: '#18181b',   /* 패널 배경 (Zinc-900) */
                            hover: '#27272a',   /* 호버 상태 배경 (Zinc-800) */
                            input: '#202023'    /* 입력창 배경 */
                        },
                        ui: { 
                            border: '#27272a',  /* 테두리 색상 */
                            selected: '#3f3f46',/* 선택됨 (Zinc-700) */
                            accent: '#3b82f6',  /* 강조 (Blue-500) */
                            danger: '#ef4444',  /* 위험/삭제 (Red-500) */
                            success: '#22c55e'  /* 성공 (Green-500) */
                        },
                        text: { 
                            main: '#f4f4f5',    /* 메인 텍스트 (Zinc-100) */
                            sub: '#a1a1aa',     /* 서브 텍스트 (Zinc-400) */
                            inv: '#18181b'      /* 반전 텍스트 (검정) */
                        }
                    },
                    fontSize: { 
                        'xxs': '10px' 
                    },
                    spacing: { 
                        '15px': '15px' 
                    },
                    cursor: { 
                        'ew-resize': 'ew-resize', 
                        'ns-resize': 'ns-resize',
                        'row-resize': 'row-resize',
                        'col-resize': 'col-resize'
                    }
                }
            }
        }
    </script>

    <style>
        /* [전역 설정] */
        body { 
            background-color: #09090b; 
            color: #f4f4f5; 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
        }
        
        /* 스크롤바 커스터마이징 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* 타임라인 그리드 레이아웃 */
        .timeline-grid { 
            display: grid; 
            height: 100%; 
            overflow: hidden; /* 내부 컨테이너 스크롤 사용 */
        }
        
        /* 고정 요소 (Sticky Headers & Rulers) */
        .sticky-corner { position: sticky; top: 0; left: 0; z-index: 50; background: #18181b; border-bottom: 1px solid #27272a; border-right: 1px solid #27272a; }
        .sticky-ruler { position: sticky; top: 0; z-index: 40; background: #09090b; border-bottom: 1px solid #27272a; }
        .sticky-col { position: sticky; left: 0; z-index: 30; background: #18181b; border-right: 1px solid #27272a; }

        /* 클립(Clip) 스타일 */
        .clip { 
            position: absolute; 
            top: 4px; 
            height: 32px; 
            border-radius: 4px; 
            overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.1); 
            cursor: pointer; 
            transition: box-shadow 0.1s, border-color 0.1s; 
            touch-action: none;
        }
        .clip:hover { 
            filter: brightness(1.1); 
            z-index: 10; 
            border-color: rgba(255,255,255,0.5); 
        }
        .clip.selected { 
            border: 2px solid #fff; 
            z-index: 20; 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); 
        }
        .clip.dragging { 
            opacity: 0.8; 
            z-index: 100 !important; 
            cursor: grabbing; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
        }
        .clip-label { 
            pointer-events: none; 
            text-shadow: 0 1px 2px black; 
            font-size: 10px;
            padding: 2px 6px;
            font-weight: bold;
            color: white;
            position: relative;
            z-index: 2;
        }

        /* 오디오 파형 및 볼륨 라인 */
        .waveform { 
            position: absolute; top: 50%; left: 0; width: 100%; height: 100%; 
            transform: translateY(-50%); opacity: 0.6; pointer-events: none; 
        }
        .volume-line { 
            position: absolute; top: 30%; left: 0; width: 100%; height: 2px; 
            background: rgba(255,255,255,0.8); cursor: ns-resize; z-index: 5; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.5); 
        }
        .volume-line:hover { background: #3b82f6; height: 3px; }

        /* 프리뷰 캔버스 박스 (점선 자석 박스) */
        .canvas-scaler { 
            transform-origin: top left; 
            background-color: #000; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            position: relative; 
        }
        .canvas-box { 
            position: absolute; 
            border: 2px dashed rgba(255,255,255,0.3); 
            background: rgba(255,255,255,0.05);
            display: flex; align-items: flex-start; justify-content: flex-end; 
            touch-action: none; box-sizing: border-box; 
        }
        .canvas-box.selected { 
            border-style: solid; 
            box-shadow: 0 0 0 1px #fff, 0 0 10px rgba(0,0,0,0.5); 
            z-index: 1000 !important; 
            border-color: #3b82f6;
        }
        .canvas-label { 
            position: absolute; right: 0; bottom: -16px; 
            background: #3b82f6; color: #fff; 
            padding: 0 4px; font-size: 9px; font-weight: bold; 
            border-radius: 2px; font-family: monospace; 
            white-space: nowrap; pointer-events: none; 
            text-shadow: 0 1px 2px black; opacity: 0.8; 
        }
        
        /* 박스 리사이즈 핸들러 */
        .box-handle { 
            position: absolute; width: 8px; height: 8px; 
            background: #fff; border: 1px solid #000; 
            z-index: 20; display: none; 
        }
        .canvas-box.selected .box-handle { display: block; }
        .bh-tl { top: -4px; left: -4px; cursor: nwse-resize; }
        .bh-tr { top: -4px; right: -4px; cursor: nesw-resize; }
        .bh-bl { bottom: -4px; left: -4px; cursor: nesw-resize; }
        .bh-br { bottom: -4px; right: -4px; cursor: nwse-resize; }
        
        /* 스냅 플래시 효과 */
        @keyframes flash { 
            0% { background-color: rgba(255,255,255,0.8); } 
            100% { background-color: rgba(255,255,255,0.05); } 
        }
        .snap-flash { animation: flash 0.3s ease-out; border-color: #fff !important; }

        /* 가이드라인 (십자선) */
        .guide-line-h { 
            position: absolute; left: 0; right: 0; height: 1px; 
            background-color: #3b82f6; border-top: 1px dashed #3b82f6; 
            display: none; pointer-events: none; z-index: 9999; opacity: 0.8; 
        }
        .guide-line-v { 
            position: absolute; top: 0; bottom: 0; width: 1px; 
            background-color: #3b82f6; border-left: 1px dashed #3b82f6; 
            display: none; pointer-events: none; z-index: 9999; opacity: 0.8; 
        }

        /* 패널 리사이저 (Panel Resizers) */
        .panel-resizer-v { 
            position: absolute; top: 0; bottom: 0; width: 4px; 
            cursor: col-resize; z-index: 100; transition: background 0.2s; 
        }
        .panel-resizer-v:hover { background: #3b82f6; }
        
        .panel-resizer-h { 
            width: 100%; height: 4px; background: #18181b; 
            cursor: row-resize; z-index: 100; transition: background 0.2s; 
            border-top: 1px solid #27272a; border-bottom: 1px solid #27272a; 
        }
        .panel-resizer-h:hover { background: #3b82f6; }

        /* 트랙 리사이저 */
        .resizer-w { 
            position: absolute; top: 0; right: 0; width: 5px; height: 100%; 
            cursor: col-resize; z-index: 60; 
        }
        .resizer-h { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; 
            cursor: row-resize; z-index: 60; 
        }
        .resizer-h:hover, .resizer-w:hover { background-color: #3b82f6; }

        /* 공통 UI 유틸리티 */
        .tool-btn { 
            @apply p-1 rounded text-text-sub hover:text-text-main hover:bg-bg-hover transition-colors text-xs flex items-center justify-center w-6 h-6; 
        }
        .tool-btn.active { @apply text-ui-accent bg-bg-hover; }
        
        .nav-btn { 
            @apply px-3 py-1 text-xs text-text-sub hover:text-text-main hover:bg-ui-selected rounded transition-colors cursor-pointer h-full flex items-center; 
        }
        .nav-btn.active { @apply text-text-main font-bold bg-bg-hover; }
        
        .win-btn { 
            @apply w-10 h-full flex items-center justify-center text-text-sub hover:bg-bg-hover hover:text-text-main transition-colors text-xs; 
        }
        .win-btn.close:hover { @apply bg-ui-danger text-white; }

        /* 커스텀 드롭다운 (FIXED) */
        .c-dropdown { 
            @apply relative inline-flex items-center px-2 h-full bg-bg-input rounded text-[10px] text-text-sub cursor-pointer hover:bg-bg-hover hover:text-text-main border border-ui-border select-none; 
        }
        .c-dropdown-menu { 
            display: none; /* 기본 숨김 */
            position: absolute; top: 105%; left: 0; width: 100%; 
            background-color: #18181b; border: 1px solid #27272a; border-radius: 4px; 
            flex-direction: column; z-index: 1000; shadow-xl; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .c-dropdown.open .c-dropdown-menu { display: flex; } /* .open 클래스가 있을 때만 표시 */
        
        .c-dropdown-item { @apply p-2 text-center hover:bg-ui-accent hover:text-white transition-colors; }
        .c-dropdown.locked { cursor: not-allowed; opacity: 0.7; border-color: #333; background: #1a1a1a; }
        .c-dropdown.locked:hover { background: #1a1a1a; color: #a1a1aa; }
        .c-dropdown.locked:hover .c-dropdown-menu { display: none; }

        /* 개발자 모드 (Dev Mode Overlay) */
        .dev-overlay { 
            pointer-events: none; position: fixed; inset: 0; z-index: 9999; display: none; 
        }
        body.dev-mode-active .dev-overlay { display: block; }
        
        .dev-highlight { 
            position: absolute; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1); 
            transition: all 0.05s ease-out; pointer-events: none;
        }
        
        .dev-tooltip { 
            position: absolute; background: #ef4444; color: white; padding: 4px 8px; 
            font-size: 10px; border-radius: 2px; font-family: monospace; white-space: pre; 
            z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.5); pointer-events: none;
        }
        
        body.dev-mode-full [data-dev]:hover::after {
            content: attr(data-dev); position: absolute; z-index: 99999;
            background: rgba(0,0,0,0.95); color: #00ff00; padding: 6px; border: 1px solid #ef4444;
            font-size: 10px; font-family: monospace; white-space: pre; border-radius: 2px;
            bottom: 100%; left: 0; min-width: 200px; pointer-events: none; text-align: left;
        }

        /* 컨텍스트 메뉴 (Context Menu) */
        .context-menu { 
            position: fixed; background: #1e1e1e; border: 1px solid #333; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 5000; border-radius: 4px; 
            padding: 4px 0; min-width: 120px; 
        }
        .ctx-item { padding: 4px 12px; font-size: 11px; color: #eee; cursor: pointer; display: flex; justify-content: space-between; gap: 10px; }
        .ctx-item:hover { background: #3b82f6; color: white; }
        
        /* 색상 선택 그리드 */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; padding: 4px; }
        .color-swatch { width: 16px; height: 16px; border-radius: 2px; cursor: pointer; border: 1px solid #333; }
        .color-swatch:hover { border-color: white; transform: scale(1.1); }

        /* Drag Overlay Highlight */
        .timeline-drag-over { box-shadow: inset 0 0 0 2px #3b82f6; background-color: rgba(59, 130, 246, 0.1); }

        /* 플레이헤드 (Playhead) */
        .playhead-line { position: absolute; top: 0; bottom: 0; width: 1px; background: #ef4444; z-index: 40; pointer-events: none; }
        .playhead-handle { position: absolute; top: 0; width: 11px; height: 12px; background: #ef4444; transform: translateX(-50%); clip-path: polygon(0 0, 100% 0, 50% 100%); cursor: ew-resize; pointer-events: auto; z-index: 50; }
        
        /* Modal Style */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .modal-window { background: #18181b; border: 1px solid #27272a; border-radius: 8px; width: 80%; height: 80%; max-width: 1000px; max-height: 700px; display: flex; flex-direction: column; overflow: hidden; }

        /* Animation */
        .animate-fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col text-xs" data-dev="ID: app-root\nComp: AppCore\nNote: 애플리케이션 최상위 컨테이너">

    <div id="vue-app" class="flex flex-col h-screen">
        
        <header id="app-header" class="h-12 bg-bg-panel border-b border-ui-border flex items-center justify-between shrink-0 select-none px-[15px]" data-dev="ID: header\nComp: Header\nNote: 상단 헤더 영역">
            <div class="flex items-center h-full gap-[15px]">
                <div class="font-bold text-lg tracking-tighter text-text-main" data-dev="ID: app-logo">WAI</div>
                
                <div class="relative group h-full flex items-center" data-dev="ID: menu-main\nComp: Header\nNote: 메인 메뉴 (비활성)">
                    <button class="text-lg text-text-sub hover:text-text-main"><i class="fa-solid fa-bars"></i></button>
                </div>

                <nav class="flex items-center gap-[15px] h-full" data-dev="ID: nav-container\nComp: Header/Navigation\nNote: 메인 네비게이션 컨테이너">
                    <button class="nav-btn hover:text-white text-text-sub" @click="firePython('nav_explore')" data-dev="ID: nav-explore\nEvent: Click -> Py:nav('explore')">탐색</button>
                    <button class="nav-btn active" @click="isProjectModalOpen = true" data-dev="ID: nav-create\nEvent: Click -> Vue:isProjectModalOpen=true">제작</button>
                    
                    <div class="relative group h-full flex items-center" data-dev="ID: nav-assets-group">
                        <button class="nav-btn hover:text-white text-text-sub" data-dev="ID: nav-assets">자산</button>
                        <div class="absolute top-full left-0 w-32 bg-bg-panel border border-ui-border shadow-xl rounded-b hidden group-hover:block z-50">
                            <button class="w-full text-left px-4 py-2 hover:bg-bg-hover text-xs text-text-main" @click="firePython('open_asset_manager')" data-dev="ID: menu-asset-manage\nEvent: Click -> Py:open_asset_manager()">자산 관리</button>
                        </div>
                    </div>

                    <button class="nav-btn hover:text-white text-text-sub" @click="firePython('nav_settings')" data-dev="ID: nav-settings\nEvent: Click -> Py:nav('settings')">설정</button>
                    <button class="nav-btn hover:text-white text-text-sub" @click="firePython('nav_research')" data-dev="ID: nav-research\nEvent: Click -> Py:nav('research')">연구</button>
                </nav>
            </div>
            
            <div class="flex items-center h-full gap-0">
                <button id="inspector-toggle" 
                        class="h-6 px-3 border border-ui-border rounded-l text-text-sub hover:text-white hover:bg-bg-hover flex items-center gap-1 transition-colors" 
                        :class="{'bg-ui-selected text-text-main': isDevModeActive}"
                        @click="toggleDevMode('active')"
                        data-dev="ID: btn-inspector-mode\nEvent: Click -> Vue:toggleDevMode('active')\nState: Read: isDevModeActive">
                    <i class="fa-solid fa-magnifying-glass"></i> Inspect
                </button>

                <button id="dev-toggle" 
                        class="h-6 px-3 border border-ui-border border-l-0 rounded-r text-text-sub hover:text-white hover:bg-bg-hover flex items-center gap-1 mr-4 transition-colors" 
                        :class="{'bg-ui-selected text-text-main': isDevModeFull}"
                        @click="toggleDevMode('full')"
                        data-dev="ID: btn-dev-mode-full\nEvent: Click -> Vue:toggleDevMode('full')\nState: Read: isDevModeFull">
                    <i class="fa-solid fa-code"></i> Dev
                </button>

                <div class="flex items-center h-full ml-[15px] gap-0 border-l border-ui-border pl-2" data-dev="ID: win-controls\nComp: System\nNote: 윈도우 창 제어 그룹">
                    <button class="win-btn" @click="firePython('win_min')" data-dev="ID: win-min\nEvent: Click -> Py:win_minimize()">
                        <i class="fa-solid fa-minus text-[10px]"></i>
                    </button>
                    <button class="win-btn" @click="firePython('win_max')" data-dev="ID: win-max\nEvent: Click -> Py:win_maximize()">
                        <i class="fa-regular fa-square text-[10px]"></i>
                    </button>
                    <button class="win-btn close" @click="firePython('win_close')" data-dev="ID: win-close\nEvent: Click -> Py:win_close()">
                        <i class="fa-solid fa-xmark text-[10px]"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden relative" id="main-layout" data-dev="ID: main-content">
            
            <aside id="panel-left" class="bg-bg-panel flex flex-col relative border-r border-ui-border" :style="{ width: leftPanelWidth + 'px', minWidth: '180px' }" data-dev="ID: panel-left\nComp: LeftPanel\nState: Read: leftPanelWidth\nNote: 좌측 패널 (자산 라이브러리)">
                <div class="p-2 border-b border-ui-border font-bold text-text-sub flex justify-between" data-dev="ID: panel-left-header">
                    <span>자산 (Assets)</span>
                    <button class="text-xs hover:text-white" @click="firePython('import_asset')" data-dev="ID: btn-add-asset\nEvent: Click -> Py:import_asset()">+</button>
                </div>
                <div class="flex-1 overflow-y-auto p-2 flex flex-col items-center justify-center text-text-sub opacity-30 gap-2" id="react-asset-list">
                    <i class="fa-solid fa-folder-open text-2xl"></i>
                    <div class="text-[10px]">자산 목록이 비어있습니다.</div>
                </div>
                
                <div class="panel-resizer-v right-0" id="resizer-left" data-dev="ID: resizer-left\nEvent: Drag -> Vue:resizePanel('left')\nNote: 좌측 패널 너비 조절 핸들"></div>
            </aside>

            <section class="flex-1 flex flex-col bg-bg-dark min-w-[400px] relative overflow-hidden" data-dev="ID: panel-center\nComp: CenterPanel\nNote: 중앙 패널 (프리뷰+타임라인)">
                
                <div id="preview-container" class="relative flex flex-col" :style="{ height: previewContainerHeight }" data-dev="ID: container-preview\nState: Read: previewContainerHeight\nNote: 프리뷰 컨테이너">
                    
                    <div class="h-8 bg-bg-panel border-b border-ui-border flex items-center justify-center px-2 gap-3 shrink-0 z-20" data-dev="ID: preview-toolbar">
                        <div class="flex items-center gap-2 bg-bg-input rounded px-3 h-6 border border-ui-border">
                            
                            <dropdown-menu :current-value="aspectRatio" :items="['16:9', '9:16', '1:1']" @select="setAspect" id="dd-ratio" data-dev="ID: dd-ratio"></dropdown-menu>

                            <div class="w-px h-3 bg-ui-border"></div>
                            
                            <div class="c-info-box px-2 flex items-center bg-bg-input rounded h-6 border border-ui-border w-24 justify-center" data-dev="ID: box-coords">
                                <span id="coord-display" class="text-xxs font-mono text-ui-accent" data-dev="ID: txt-coord">{{ Math.round(mouseCoord.x) }}, {{ Math.round(mouseCoord.y) }}</span>
                            </div>

                            <div class="w-px h-3 bg-ui-border"></div>

                            <dropdown-menu :current-value="resolution" :items="['8K', '6K', '4K', '3K', '2K']" @select="setResolution" id="dd-resolution" data-dev="ID: dd-resolution"></dropdown-menu>
                            
                            <div class="w-px h-3 bg-ui-border"></div>

                            <div class="cursor-pointer flex items-center gap-1 hover:text-white text-[10px] font-bold" @click="isMagnet = !isMagnet" :class="{'text-ui-accent': isMagnet, 'text-text-sub': !isMagnet}" data-dev="ID: btn-magnet">
                                <i class="fa-solid fa-magnet mr-1"></i> SNAP {{ isMagnet ? 'ON' : 'OFF' }}
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 relative overflow-hidden bg-black flex items-center justify-center" id="canvas-wrapper" 
                         @mousemove="updateCanvasMouseCoord" @mouseleave="mouseCoord = {x: 0, y: 0}; isMouseOverCanvas = false"
                         data-dev="ID: canvas-wrapper">
                        
                        <div class="absolute top-0 left-0 w-full h-5 bg-[#121212] border-b border-[#333] z-20 pl-5 flex overflow-hidden" id="ruler-h">
                            <ruler-line :orientation="'h'" :max-size="canvasSize.w" :scale="canvasScale"></ruler-line>
                        </div>
                        <div class="absolute top-0 left-0 w-5 h-full bg-[#121212] border-r border-[#333] z-20 pt-5 flex flex-col overflow-hidden" id="ruler-v">
                            <ruler-line :orientation="'v'" :max-size="canvasSize.h" :scale="canvasScale"></ruler-line>
                        </div>

                        <div class="absolute top-0 left-0 w-full h-full z-30 pointer-events-none" :style="{paddingLeft: '20px', paddingTop: '20px'}">
                            <div class="absolute w-px h-full bg-ui-accent opacity-30" :style="{left: mouseMarkerPos.x + 'px'}" v-show="isMouseOverCanvas"></div>
                            <div class="absolute h-px w-full bg-ui-accent opacity-30" :style="{top: mouseMarkerPos.y + 'px'}" v-show="isMouseOverCanvas"></div>
                        </div>

                        <div class="relative overflow-hidden" id="canvas-viewport" style="width:100%; height:100%;">
                            <div id="canvas-scaler" class="canvas-scaler" :style="canvasScalerStyle">
                                <div id="guide-h" class="guide-line-h" style="top: 50%;"></div>
                                <div id="guide-v" class="guide-line-v" style="left: 50%;"></div>
                                
                                <preview-canvas :canvas-boxes="canvasBoxes" :selected-box-id="selectedBoxId" @select-box="setSelectedBoxId" @remove-box="removeBox"></preview-canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-resizer-h" id="resizer-timeline" data-dev="ID: resizer-center\nEvent: Drag -> Vue:resizePanel('center')"></div>

                <timeline-panel :vm="$data" :style="{ height: timelineContainerHeight }"></timeline-panel>
            </section>

            <aside id="panel-right" class="bg-bg-panel flex flex-col relative border-l border-ui-border" :style="{ width: rightPanelWidth + 'px', minWidth: '250px' }" data-dev="ID: panel-right\nComp: RightPanel\nState: Read: rightPanelWidth\nNote: 우측 패널 (속성+레이어)">
                <div class="panel-resizer-v left-0" id="resizer-right" data-dev="ID: resizer-right\nEvent: Drag -> Vue:resizePanel('right')\nNote: 우측 패널 너비 조절 핸들"></div>
                <div class="flex-1 overflow-y-auto flex flex-col" id="vue-right-panel-root">
                    <layer-panel :vm="$data"></layer-panel>
                    <properties-panel :vm="$data"></properties-panel>
                    <div class="flex-1 bg-bg-dark border-t border-ui-border p-2"><div class="text-[10px] text-text-sub text-center opacity-30 mt-4">Effects Library</div></div>
                </div>
            </aside>

        </main>

        <project-modal v-if="isProjectModalOpen" @close="isProjectModalOpen = false"></project-modal>

        <div class="dev-overlay" id="dev-overlay" v-if="inspector.tag">
            <div class="dev-highlight" :style="highlightStyle"></div>
            <div class="dev-tooltip" :style="tooltipStyle">
                <span class="text-yellow-400 font-bold">{{ inspector.tag }}</span> 
                <span class="text-blue-300">{{ inspector.id ? '#' + inspector.id : '' }}</span> 
                <span class="text-green-300">{{ inspector.className ? '.' + inspector.className.split(' ')[0] : '' }}</span><br>
                Size: {{ inspector.w }} x {{ inspector.h }}<br>
                <div v-if="inspector.dataDev" class="mt-1 pt-1 border-t border-gray-500 text-[9px] text-gray-300">
                    {{ inspector.dataDev }}
                </div>
            </div>
        </div>
        
    </div> <script>
        const { createApp, reactive, ref, onMounted, computed, nextTick } = Vue;

        const Z_INDEX_OFFSETS = { 'BG': 20, 'TXT': 40, 'VID': 60, 'AUD': 80 };
        const COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e', '#10b981', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#ffffff', '#9ca3af', '#4b5563', '#000000', '#7f1d1d', '#7c2d12', '#78350f', '#365314', '#14532d', '#064e3b', '#164e63', '#0c4a6e', '#1e3a8a', '#312e81', '#4c1d95', '#701a75', '#881337'];
        
        // --- Component Definitions ---

        // Dropdown Menu Component (Reusable)
        const DropdownMenu = {
            props: ['currentValue', 'items', 'id'],
            template: `
                <div :id="id" class="c-dropdown w-20 h-6 border-none bg-transparent px-0" :class="{ 'open': isOpen }" @click="toggleDropdown" @click.stop>
                    <span :id="'val-' + id" class="truncate max-w-[80%]">{{ currentValue }}</span> <i class="fa-solid fa-caret-down ml-auto text-[8px]"></i>
                    <div class="c-dropdown-menu">
                        <div class="c-dropdown-item" v-for="item in items" :key="item" @click="$emit('select', item); isOpen = false">
                            {{ item }}
                        </div>
                    </div>
                </div>
            `,
            data() { return { isOpen: false } },
            methods: {
                toggleDropdown() { this.isOpen = !this.isOpen; },
                closeOnOutsideClick(e) { if (!this.$el.contains(e.target)) this.isOpen = false; }
            },
            mounted() { document.addEventListener('click', this.closeOnOutsideClick); },
            beforeUnmount() { document.removeEventListener('click', this.closeOnOutsideClick); }
        };

        // Ruler Line Component
        const RulerLine = {
            props: ['orientation', 'maxSize', 'scale'],
            template: `
                <div class="absolute inset-0 overflow-hidden" :style="wrapperStyle">
                    <template v-if="orientation === 'h'">
                        <div v-for="i in majorTicks" :key="i" :style="horizontalTickStyle(i)" class="absolute top-0 text-xxs text-text-sub font-mono pl-1 border-l border-ui-border h-full">
                            {{ i }}
                        </div>
                    </template>
                    <template v-else>
                        <div v-for="i in majorTicks" :key="i" :style="verticalTickStyle(i)" class="absolute left-0 text-xxs text-text-sub font-mono pt-px border-t border-ui-border w-full">
                            {{ i }}
                        </div>
                    </template>
                </div>
            `,
            computed: {
                majorTicks() {
                    const step = 100; // Major tick every 100px in 4K space
                    const ticks = [];
                    const maxScaledSize = this.maxSize * this.scale;
                    
                    for (let i = step; i < this.maxSize; i += step) {
                        if (i * this.scale < (this.orientation === 'h' ? 3840 : 2160)) {
                            ticks.push(i);
                        }
                    }
                    return ticks;
                },
                wrapperStyle() {
                    return this.orientation === 'h' ? 
                        { width: this.maxSize * this.scale + 'px', height: '100%', transformOrigin: 'top left', transform: `scaleX(${1/this.scale})` } : 
                        { width: '100%', height: this.maxSize * this.scale + 'px', transformOrigin: 'top left', transform: `scaleY(${1/this.scale})` };
                }
            },
            methods: {
                horizontalTickStyle(val) {
                    return { left: val + 'px' };
                },
                verticalTickStyle(val) {
                    return { top: val + 'px' };
                }
            }
        };

        // Project Modal Component
        const ProjectModal = {
            template: `
                <div class="modal-overlay" @click="$emit('close')" data-dev="ID: modal-project\nComp: Modal\nNote: 프로젝트 관리 모달창">
                    <div class="modal-window" @click.stop>
                        <div class="h-10 border-b border-ui-border flex items-center justify-between px-4 bg-bg-panel text-text-main font-bold">
                            프로젝트 관리 
                            <button @click="$emit('close')" class="win-btn close">
                                <i class="fa-solid fa-xmark text-[10px]"></i>
                            </button>
                        </div>
                        <div class="flex-1 flex">
                            <div class="w-40 border-r border-ui-border p-2 bg-bg-hover">Folders...</div>
                            <div class="flex-1 bg-bg-dark p-4">Files...</div>
                        </div>
                    </div>
                </div>
            `
        };

        // Layer Panel Component (Matrix UI 구현)
        const LayerPanel = {
            props: ['vm'],
            template: `
                <div class="border-b border-ui-border bg-bg-panel select-none" data-dev="ID: layer-panel\nComp: RightPanel/Layer\nNote: 레이어 매트릭스 및 관리">
                    <div class="h-8 bg-bg-hover flex items-center justify-between px-3 cursor-pointer border-b border-ui-border" @click="isCollapsed = !isCollapsed" data-dev="ID: layer-header">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-text-main flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> 레이어 관리</span>
                            <span v-if="vm.layerMainName" class="text-[10px] text-ui-accent border border-ui-accent px-1 rounded">{{ vm.layerMainName }}</span>
                        </div>
                        <i :class="['fa-solid', isCollapsed ? 'fa-chevron-down' : 'fa-chevron-up']" class="text-text-sub text-xs"></i>
                    </div>
                    <div v-if="!isCollapsed" class="p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-text-sub">매트릭스 (우클릭: 색상)</span>
                            <button class="text-[10px] hover:text-white bg-ui-selected px-2 rounded" @click="addColumn">+ 컬럼</button>
                        </div>
                        <div class="overflow-x-auto pb-2">
                            <div class="flex gap-1 mb-1 min-w-max">
                                <div class="w-10 shrink-0"></div>
                                <div v-for="(col, i) in vm.layerCols" :key="col.id" 
                                     class="w-[50px] text-center py-1 rounded text-[10px] font-bold text-white cursor-context-menu hover:brightness-110 relative group" 
                                     :style="{ backgroundColor: col.color }" 
                                     @contextmenu.prevent="openContextMenu($event, col.id, i)">
                                    <input type="text" :value="col.name" @input="updateColName(col.id, $event.target.value)" class="bg-transparent text-center w-full outline-none" @click.stop />
                                    <div class="absolute top-0 right-0 text-[8px] opacity-0 group-hover:opacity-100 p-0.5 bg-black/50 rounded">Z:{{ getZIndex(i, 'VID') }}</div>
                                </div>
                            </div>
                            <div v-for="row in rows" :key="row.type" class="flex gap-1 mb-1 min-w-max">
                                <div class="w-10 shrink-0 text-[9px] flex items-center justify-end pr-2 font-bold" :style="{ color: row.color }">{{ row.label }}</div>
                                <div v-for="(col, i) in vm.layerCols" :key="col.id + row.type"
                                    :class="{ 'opacity-100 ring-1 ring-white': isActive(i, row.type), 'opacity-30 grayscale': !isActive(i, row.type) }"
                                    class="w-[50px] h-6 border border-ui-border rounded flex flex-col items-center justify-center cursor-pointer hover:border-white transition-all" 
                                    :style="{ backgroundColor: '#27272a' }" 
                                    @click="vm.addLayerBox(i, row.type, col.color)" 
                                    :data-dev="'ID: cell-' + i + '-' + row.type + '\\nZ: ' + getZIndex(i, row.type)">
                                    <span class="text-[10px] font-bold text-white drop-shadow-md" style="text-shadow: 0 0 3px black">{{ getZIndex(i, row.type) }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 flex justify-end">
                            <button class="text-xs bg-ui-accent text-white px-3 py-1 rounded hover:bg-blue-600" @click="saveLayerTemplate">저장</button>
                        </div>
                    </div>
                    <div v-if="contextMenu" class="context-menu" :style="{top: contextMenu.y + 'px', left: contextMenu.x + 'px'}">
                        <div class="color-grid">
                            <div v-for="c in COLORS" :key="c" class="color-swatch" :style="{ backgroundColor: c }" @click="handleColColor(c)"></div>
                        </div>
                    </div>
                </div>
            `,
            data() {
                return {
                    isCollapsed: false,
                    contextMenu: null,
                    rows: [
                        { type: 'EFF', label: 'Effect', color: '#ef4444', offset: 80 }, 
                        { type: 'TXT', label: 'Text', color: '#eab308', offset: 40 }, 
                        { type: 'BG', label: 'BG', color: '#3b82f6', offset: 20 }
                    ],
                    COLORS: COLORS
                }
            },
            methods: {
                getZIndex(colIdx, type) {
                    const base = (colIdx * 100) + 100;
                    // Finding the offset from the rows data
                    const row = this.rows.find(r => r.type === type);
                    const offset = row ? row.offset : 0;
                    return base + offset;
                },
                isActive(colIdx, type) {
                    return this.vm.canvasBoxes.some(b => b.colIdx === colIdx && b.type === type);
                },
                addColumn() {
                    const newCol = { id: `lc_${Date.now()}`, name: 'New', color: '#333' };
                    this.vm.layerCols.push(newCol);
                },
                updateColName(id, name) {
                    const col = this.vm.layerCols.find(c => c.id === id);
                    if (col) col.name = name;
                },
                openContextMenu(e, id, index) {
                    this.contextMenu = { x: e.clientX, y: e.clientY, colId: id, colIndex: index };
                },
                handleColColor(color) {
                    const colId = this.contextMenu.colId;
                    this.vm.layerCols = this.vm.layerCols.map(col => 
                        col.id === colId ? { ...col, color: color } : col
                    );
                    this.contextMenu = null;
                },
                async saveLayerTemplate() {
                    const { value: name } = await Swal.fire({ 
                        title: '레이어 템플릿 저장', 
                        input: 'text', 
                        inputLabel: '메인 레이어 이름', 
                        inputPlaceholder: '예: News_Layout', 
                        showCancelButton: true, 
                        background: '#1e1e1e', 
                        color: '#fff', 
                        confirmButtonColor: '#3b82f6' 
                    });
                    if (name) { 
                        this.vm.saveLayerTemplate(name); 
                        Swal.fire({icon:'success', title:'저장됨', background:'#1e1e1e', color:'#fff', confirmButtonColor:'#3b82f6'}); 
                    }
                }
            }
        };

        // Properties Panel Component
        const PropertiesPanel = {
            props: ['vm'],
            template: `
                <div class="border-b border-ui-border bg-bg-panel" data-dev="ID: props-panel\nComp: RightPanel/Properties\nNote: 클립/박스 속성 표시">
                    <div class="h-8 bg-bg-hover flex items-center justify-between px-2 cursor-pointer select-none border-b border-ui-border" @click="isCollapsed = !isCollapsed" data-dev="ID: props-header">
                        <span class="text-xs font-bold text-text-main"><i class="fa-solid fa-sliders mr-2"></i>속성</span>
                        <i :class="['fa-solid', isCollapsed ? 'fa-chevron-down' : 'fa-chevron-up']" class="text-text-sub text-xs"></i>
                    </div>
                    <div v-if="!isCollapsed" class="p-3 space-y-3">
                        <div v-if="!vm.selectedClip && !vm.selectedBoxId" class="text-text-sub text-center text-[10px] py-4 opacity-50">선택된 요소 없음</div>
                        
                        <div v-else-if="vm.selectedClip" class="animate-fade-in space-y-2">
                            <div class="bg-bg-input p-2 rounded border border-ui-border">
                                <div class="text-[10px] text-ui-accent font-bold mb-1">CLIP</div>
                                <div class="text-sm font-bold text-text-main truncate">{{ vm.selectedClip.name }}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-text-sub">Start</label>
                                    <input type="text" class="w-full bg-bg-dark border border-ui-border rounded p-1 text-[10px] text-text-main" :value="vm.selectedClip.start.toFixed(1)" readonly/>
                                </div>
                                <div>
                                    <label class="text-[10px] text-text-sub">Dur</label>
                                    <input type="text" class="w-full bg-bg-dark border border-ui-border rounded p-1 text-[10px] text-text-main" :value="vm.selectedClip.duration.toFixed(1)" readonly/>
                                </div>
                            </div>
                            <button class="w-full bg-ui-border hover:bg-ui-danger hover:text-white border border-ui-border text-text-sub py-1 rounded text-[10px] transition-colors" @click="deleteClip(vm.selectedClip.id)">
                                <i class="fa-solid fa-trash mr-1"></i> 삭제
                            </button>
                        </div>
                        
                        <div v-else-if="selectedBox" class="animate-fade-in space-y-2">
                            <div class="bg-bg-input p-2 rounded border border-ui-border">
                                <div class="text-[10px] text-ui-accent font-bold mb-1">BOX (Z:{{ selectedBox.zIndex }})</div>
                                <div class="text-sm font-bold text-text-main truncate">({{ selectedBox.type }})</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-[10px] text-text-sub">X</label><input type="text" class="w-full bg-bg-dark border border-ui-border rounded p-1 text-[10px] text-text-main" :value="Math.round(selectedBox.x)" readonly/></div>
                                <div><label class="text-[10px] text-text-sub">Y</label><input type="text" class="w-full bg-bg-dark border border-ui-border rounded p-1 text-[10px] text-text-main" :value="Math.round(selectedBox.y)" readonly/></div>
                                <div><label class="text-[10px] text-text-sub">W</label><input type="text" class="w-full bg-bg-dark border border-ui-border rounded p-1 text-[10px] text-text-main" :value="Math.round(selectedBox.w)" readonly/></div>
                                <div><label class="text-[10px] text-text-sub">H</label><input type="text" class="w-full bg-bg-dark border border-ui-border rounded p-1 text-[10px] text-text-main" :value="Math.round(selectedBox.h)" readonly/></div>
                            </div>
                            <button class="w-full bg-ui-border hover:bg-ui-danger hover:text-white border border-ui-border text-text-sub py-1 rounded text-[10px] transition-colors" @click="vm.removeBox(vm.selectedBoxId)">
                                <i class="fa-solid fa-trash mr-1"></i> 삭제
                            </button>
                        </div>
                    </div>
                </div>
            `,
            data() { return { isCollapsed: false } },
            computed: {
                selectedBox() {
                    return this.vm.canvasBoxes.find(b => b.id === this.vm.selectedBoxId);
                }
            },
            methods: {
                deleteClip(id) {
                    this.vm.removeClip(id);
                    this.vm.selectedClip = null;
                }
            }
        };

        // Preview Canvas Component
        const PreviewCanvas = {
            props: ['canvasBoxes', 'selectedBoxId'],
            template: `
                <div ref="container" class="absolute inset-0 z-30 pointer-events-none" @click="contextMenu = null; $emit('select-box', null)">
                    <div v-for="box in canvasBoxes" :key="box.id" 
                         :id="'box-' + box.id"
                         class="canvas-box pointer-events-auto"
                         :class="{ 'selected': selectedBoxId === box.id }"
                         :style="{ left: box.x + 'px', top: box.y + 'px', width: box.w + 'px', height: box.h + 'px', borderColor: box.color, zIndex: box.zIndex }"
                         @mousedown.stop="$emit('select-box', box.id)"
                         @contextmenu.prevent="handleContext($event, box.id)"
                         data-x="0" data-y="0"
                         :data-dev="'ID: box-' + box.id + '\\nComp: CanvasBox\\nZ: ' + box.zIndex"
                    >
                        <div class="canvas-label" :style="{ backgroundColor: box.color }">Z:{{ box.zIndex }}</div>
                        <div class="box-handle bh-tl"></div><div class="box-handle bh-tr"></div><div class="box-handle bh-bl"></div><div class="box-handle bh-br"></div>
                    </div>
                    <div v-if="contextMenu" class="context-menu pointer-events-auto" :style="{top: contextMenu.y + 'px', left: contextMenu.x + 'px'}">
                        <div class="ctx-item" @click="handleContextAction('top')">맨 위로</div>
                        <div class="ctx-item" @click="handleContextAction('delete')">삭제</div>
                    </div>
                </div>
            `,
            data() { return { contextMenu: null } },
            mounted() { this.initInteract(); },
            updated() { this.initInteract(); }, 
            methods: {
                initInteract() {
                    const self = this;
                    interact('.canvas-box').unset(); 
                    
                    interact('.canvas-box').draggable({
                        modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true }) ],
                        listeners: {
                            move(e) {
                                const target = e.target;
                                const scaler = document.getElementById('canvas-scaler');
                                const scaleMatch = scaler.style.transform.match(/scale\(([^)]+)\)/);
                                const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1.0;
                                
                                let x = (parseFloat(target.getAttribute('data-x')) || 0) + (e.dx / scale);
                                let y = (parseFloat(target.getAttribute('data-y')) || 0) + (e.dy / scale);
                                
                                const cx = x + (e.rect.width/2); 
                                const centerX = 3840/2;
                                document.getElementById('guide-v').style.display = Math.abs(cx - centerX) < 20 ? 'block' : 'none';

                                target.style.transform = `translate(${x}px, ${y}px)`; 
                                target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                            },
                            end(e) {
                                document.getElementById('guide-v').style.display = 'none';

                                const boxId = e.target.id.replace('box-', '');
                                const dx = parseFloat(e.target.getAttribute('data-x')) || 0;
                                const dy = parseFloat(e.target.getAttribute('data-y')) || 0;
                                
                                self.$parent.updateBoxPosition(boxId, dx, dy, e.rect.width, e.rect.height);
                                
                                e.target.removeAttribute('data-x'); 
                                e.target.removeAttribute('data-y');
                                e.target.style.transform = `translate(0, 0)`; 
                            }
                        }
                    }).resizable({
                        edges: { left: true, right: true, bottom: true, top: true },
                        modifiers: [ interact.modifiers.restrictEdges({ outer: 'parent' }) ],
                        listeners: {
                            move: function (e) {
                                const scaler = document.getElementById('canvas-scaler');
                                const scaleMatch = scaler.style.transform.match(/scale\(([^)]+)\)/);
                                const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1.0;
                                
                                let { x, y } = e.target.dataset;
                                x = (parseFloat(x) || 0) + (e.deltaRect.left / scale);
                                y = (parseFloat(y) || 0) + (e.deltaRect.top / scale);
                                Object.assign(e.target.style, { width: `${e.rect.width/scale}px`, height: `${e.rect.height/scale}px`, transform: `translate(${x}px, ${y}px)` });
                                Object.assign(e.target.dataset, { x, y });
                            },
                            end: function(e) {
                                const scaler = document.getElementById('canvas-scaler');
                                const scaleMatch = scaler.style.transform.match(/scale\(([^)]+)\)/);
                                const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1.0;
                                
                                const boxId = e.target.id.replace('box-', '');
                                const dx = parseFloat(e.target.dataset.x) || 0;
                                const dy = parseFloat(e.target.dataset.y) || 0;
                                
                                self.$parent.updateBoxPosition(boxId, dx, dy, e.rect.width / scale, e.rect.height / scale, true); 
                                e.target.removeAttribute('data-x'); 
                                e.target.removeAttribute('data-y');
                                e.target.style.transform = `translate(0, 0)`; 
                                e.target.style.width = null;
                                e.target.style.height = null;
                            }
                        }
                    });
                },
                handleContext(e, boxId) { 
                    this.contextMenu = { x: e.clientX, y: e.clientY, boxId }; 
                },
                handleContextAction(action) { 
                    if (action === 'delete') this.$emit('remove-box', this.contextMenu.boxId);
                    this.contextMenu = null;
                }
            }
        };

        // Timeline Panel Component
        const TimelinePanel = {
            props: ['vm'],
            template: `
                <div class="flex flex-col h-full bg-bg-panel select-none" @wheel.prevent="handleWheel" data-dev="ID: timeline-area\nComp: Timeline">
                    <div class="h-8 bg-bg-panel border-b border-ui-border flex items-center px-2 justify-between shrink-0">
                        <div class="flex items-center gap-2">
                            <button class="hover:text-text-main w-6 h-6 flex items-center justify-center rounded hover:bg-bg-hover" @click="toggleCollapse">
                                <i :class="['fa-solid', vm.isTimelineCollapsed ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                            </button>
                            <span class="text-xs font-mono text-ui-accent font-bold">{{ formattedTime }}</span>
                        </div>
                        <input type="range" min="10" max="100" :value="vm.zoom" @input="vm.zoom = Number($event.target.value)" class="w-20 accent-ui-accent h-1"/>
                    </div>
                    
                    <div v-show="!vm.isTimelineCollapsed" class="h-5 bg-bg-hover border-b border-ui-border flex items-center px-2 justify-between shrink-0 text-xxs" data-dev="ID: quick-bar">
                        <div class="flex gap-1">
                            <button class="tool-btn" title="Cut" data-dev="ID: tool-cut"><i class="fa-solid fa-scissors"></i></button>
                            <button class="tool-btn" title="Delete" data-dev="ID: tool-delete"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button :class="{ 'bg-bg-input border-ui-accent text-ui-accent': vm.isMagnet, 'border-transparent hover:bg-ui-selected text-text-sub': !vm.isMagnet }" 
                                    class="flex items-center gap-1 px-2 rounded border" 
                                    @click="vm.isMagnet = !vm.isMagnet" 
                                    data-dev="ID: tool-magnet">
                                <i class="fa-solid fa-magnet"></i>
                            </button>
                            <button :class="{ 'bg-bg-input border-ui-accent text-ui-accent': vm.isAutoRipple, 'border-transparent hover:bg-ui-selected text-text-sub': !vm.isAutoRipple }" 
                                    class="flex items-center gap-1 px-2 rounded border" 
                                    @click="vm.isAutoRipple = !vm.isAutoRipple" 
                                    data-dev="ID: tool-ripple">
                                <i class="fa-solid fa-link"></i>
                            </button>
                            <div class="w-px h-3 bg-ui-border mx-1"></div>
                            <button class="tool-btn bg-ui-selected text-white px-2 py-0" data-dev="ID: btn-normalize">Normalize</button>
                            <i class="fa-solid fa-volume-high text-text-sub cursor-pointer hover:text-white" data-dev="ID: vol-control"></i>
                        </div>
                    </div>
                    
                    <div v-show="!vm.isTimelineCollapsed" class="flex-1 overflow-auto timeline-grid relative" id="timeline-scroll-area" style="grid-template-columns: 180px 1fr" 
                         @dragover="handleDragOver" @drop="handleDrop">
                        
                        <div class="sticky-col z-30 bg-bg-panel border-r border-ui-border">
                            <div class="h-6 border-b border-ui-border flex items-center justify-between px-2 text-[9px] font-bold text-text-sub bg-bg-panel z-40 sticky top-0"><span>TRACKS</span></div>
                            <div v-for="(track, index) in vm.tracks" :key="track.id" 
                                 class="h-10 border-b border-ui-border flex items-center px-2 group hover:bg-bg-hover cursor-move bg-bg-panel relative" 
                                 draggable @dragstart="onTrackDragStart($event, index)" @dragenter="onTrackDragEnter($event, index)" @dragend="onTrackDragEnd" @dragover.prevent 
                                 :data-dev="'ID: track-' + track.id">
                                <div class="w-1 h-2/3 rounded mr-2" :style="{ backgroundColor: track.color || '#666' }"></div>
                                <span class="text-xs truncate flex-1 text-text-main" contenteditable suppressContentEditableWarning>{{ track.name }}</span>
                            </div>
                        </div>

                        <div class="relative bg-bg-dark min-w-max" @mousedown="handlePlayheadDrag($event)">
                            
                            <div class="h-6 border-b border-ui-border sticky top-0 bg-bg-dark z-20 flex text-[9px] text-text-sub sticky-ruler">
                                <div v-for="i in 50" :key="i" class="border-l border-ui-border pl-1 pt-2" :style="{ width: vm.zoom * 5 + 'px' }">{{ (i - 1) * 5 }}s</div>
                            </div>
                            
                            <div v-for="track in vm.tracks" :key="track.id" class="h-10 border-b border-ui-border relative">
                                <div v-for="clip in vm.clips.filter(c => c.trackId === track.id)" :key="clip.id"
                                     :id="'clip-' + clip.id"
                                     class="clip absolute top-1 h-8 rounded cursor-pointer overflow-hidden" 
                                     :class="{ 'selected': vm.selectedClip && vm.selectedClip.id === clip.id }"
                                     :style="{ left: clip.start * vm.zoom + 'px', width: clip.duration * vm.zoom + 'px', backgroundColor: 'transparent' }"
                                     @click.stop="vm.setSelectedClip(clip)" 
                                     :data-dev="'ID: clip-' + clip.id"
                                     data-x="0" data-y="0"
                                >
                                    <div class="absolute inset-0 opacity-30" :style="{backgroundColor: track.type === 'audio' ? '#3b82f6' : track.color}"></div>
                                    
                                    <template v-if="track.type === 'audio'">
                                        <svg class="waveform" viewBox="0 0 100 100" preserveAspectRatio="none">
                                            <path d="M0 50 Q 10 20, 20 50 T 40 50 T 60 50 T 80 50 T 100 50" stroke="white" fill="transparent" stroke-width="2" vector-effect="non-scaling-stroke"/>
                                        </svg>
                                        <div class="volume-line" title="Volume"></div>
                                    </template>
                                    
                                    <div class="text-[9px] px-2 text-white truncate font-bold drop-shadow-md relative z-10 pointer-events-none">{{ clip.name }}</div>
                                </div>
                            </div>
                            
                            <div class="playhead-line" :style="{ left: vm.currentTime * vm.zoom + 'px' }"></div>
                            <div class="playhead-handle" :style="{ left: vm.currentTime * vm.zoom + 'px' }"></div>
                        </div>
                    </div>
                </div>
            `,
            computed: {
                formattedTime() {
                    const totalSeconds = this.vm.currentTime;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const milliseconds = Math.floor((totalSeconds - Math.floor(totalSeconds)) * 100); 
                    
                    const pad = (num, length = 2) => String(num).padStart(length, '0');
                    return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}:${pad(milliseconds)}`;
                }
            },
            mounted() {
                this.$nextTick(() => {
                    this.initClipInteractions();
                    this.adjustLayout();
                    window.addEventListener('resize', this.adjustLayout);
                });
            },
            beforeUnmount() {
                 window.removeEventListener('resize', this.adjustLayout);
            },
            watch: {
                'vm.clips': { handler() { this.$nextTick(this.initClipInteractions); }, deep: true },
                'vm.isMagnet': { handler() { this.$nextTick(this.initClipInteractions); } } 
            },
            methods: {
                adjustLayout() {
                    const p = document.getElementById('preview-container');
                    if (this.vm.isTimelineCollapsed) {
                        p.style.height = 'calc(100% - 32px)';
                    } else {
                        p.style.height = '50%';
                    }
                },
                initClipInteractions() {
                    const self = this;
                    interact('.clip').unset(); 

                    const snapModifier = this.vm.isMagnet ? [
                        interact.modifiers.snap({
                            targets: [
                                ({ x, y }) => {
                                    const snaps = [];
                                    const zoom = self.vm.zoom;
                                    self.vm.clips.forEach(clip => {
                                        snaps.push({ x: clip.start * zoom, range: 10 }); 
                                        snaps.push({ x: (clip.start + clip.duration) * zoom, range: 10 }); 
                                    });
                                    // Snap to Playhead
                                    snaps.push({ x: self.vm.currentTime * zoom, range: 10 });
                                    return snaps;
                                }
                            ],
                            relativePoints: [{x: 0, y: 0}, {x: 1, y: 0}] 
                        })
                    ] : [];
                    
                    interact('.clip').resizable({ 
                        edges: { left: true, right: true, bottom: false, top: false },
                        modifiers: snapModifier,
                        listeners: { 
                            move (e) { 
                                let { x } = e.target.dataset; 
                                x = (parseFloat(x) || 0) + e.deltaRect.left; 
                                Object.assign(e.target.style, { width: `${e.rect.width}px`, transform: `translate(${x}px, 0)` }); 
                                Object.assign(e.target.dataset, { x }); 
                            }, 
                            end (e) { 
                                const clipId = e.target.id.replace('clip-', '');
                                const startChange = (parseFloat(e.target.dataset.x) || 0) / self.vm.zoom;
                                const durationChange = (e.rect.width - e.rect.initialSize.width) / self.vm.zoom;
                                
                                self.$parent.updateClip(clipId, startChange, durationChange);

                                e.target.removeAttribute('data-x'); 
                                e.target.style.transform='none'; 
                            } 
                        } 
                    }).draggable({ 
                        modifiers: snapModifier,
                        listeners: { 
                            move(e) { 
                                const target = e.target; 
                                const x = (parseFloat(target.getAttribute('data-x')) || 0) + e.dx; 
                                target.style.transform = `translate(${x}px, 0)`; 
                                target.setAttribute('data-x', x); 
                            }, 
                            end(e) { 
                                const clipId = e.target.id.replace('clip-', '');
                                const timeChange = (parseFloat(e.target.getAttribute('data-x')) || 0) / self.vm.zoom;
                                
                                self.$parent.moveClip(clipId, timeChange);

                                e.target.style.transform='none'; 
                                e.target.removeAttribute('data-x'); 
                            } 
                        } 
                    });
                },
                handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; },
                handleDrop(e) { 
                    e.preventDefault(); 
                    let assetData;
                    try {
                        assetData = JSON.parse(e.dataTransfer.getData('text/wai-asset'));
                    } catch (error) {
                        return; 
                    }

                    const rect = e.currentTarget.getBoundingClientRect(); 
                    const y = e.clientY - rect.top - 24; 
                    const trackIndex = Math.floor(y / 40); 
                    
                    const scrollArea = document.getElementById('timeline-scroll-area');
                    const x = e.clientX - rect.left + scrollArea.scrollLeft - 180; 
                    const time = Math.max(0, x / this.vm.zoom); 
                    
                    this.vm.addClipFromDrop(assetData.type, trackIndex, time, assetData.name);
                },
                onTrackDragStart(e, index) { this.vm.dragItemIndex = index; },
                onTrackDragEnter(e, index) { this.vm.dragOverItemIndex = index; },
                onTrackDragEnd() { 
                    this.vm.moveTrack(this.vm.dragItemIndex, this.vm.dragOverItemIndex); 
                    this.vm.dragItemIndex = null; 
                    this.vm.dragOverItemIndex = null; 
                },
                handleWheel(e) { 
                    const scrollArea = document.getElementById('timeline-scroll-area');
                    if (e.shiftKey) { 
                        const delta = e.deltaY > 0 ? -2 : 2; 
                        this.vm.zoom = Math.max(10, Math.min(100, this.vm.zoom + delta)); 
                    } else { 
                        scrollArea.scrollLeft += e.deltaY; 
                    } 
                },
                toggleCollapse() { 
                    this.vm.isTimelineCollapsed = !this.vm.isTimelineCollapsed;
                    this.adjustLayout();
                },
                handlePlayheadDrag(e) {
                    const target = e.target;
                    if (!target.className.includes('sticky-ruler') && !target.className.includes('playhead-handle')) return;

                    e.preventDefault(); 
                    
                    const scrollArea = document.getElementById('timeline-scroll-area');
                    const rect = scrollArea.getBoundingClientRect();
                    const scrollLeft = scrollArea.scrollLeft;
                    const headerWidth = 180; 
                    const zoom = this.vm.zoom;

                    const updateTime = (event) => {
                        let newX = event.clientX - rect.left + scrollLeft - headerWidth;
                        
                        // Snap Logic for Playhead
                        if (this.vm.isMagnet) {
                             let minDiff = Infinity;
                             let snapTime = null;

                             this.vm.clips.forEach(clip => {
                                 const startPx = clip.start * zoom;
                                 const endPx = (clip.start + clip.duration) * zoom;
                                 
                                 [startPx, endPx].forEach(px => {
                                     const diff = Math.abs(newX - px);
                                     if (diff < 10 && diff < minDiff) { 
                                         minDiff = diff;
                                         snapTime = px / zoom;
                                     }
                                 });
                             });

                             if (snapTime !== null) {
                                 this.vm.currentTime = snapTime;
                                 return; 
                             }
                        }

                        this.vm.currentTime = Math.max(0, newX / zoom);
                    };

                    const onMove = (event) => updateTime(event);
                    const onUp = () => {
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    };

                    updateTime(e);
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                }
            }
        };

        // --- Main App Vue Instance ---

        const App = {
            components: { 
                'dropdown-menu': DropdownMenu, 
                'project-modal': ProjectModal, 
                'layer-panel': LayerPanel,
                'properties-panel': PropertiesPanel,
                'preview-canvas': PreviewCanvas,
                'timeline-panel': TimelinePanel,
                'ruler-line': RulerLine
            },
            data() {
                return {
                    // UI Layout State
                    leftPanelWidth: 240, 
                    rightPanelWidth: 320,
                    previewContainerHeight: '50%', 
                    timelineContainerHeight: '50%',
                    isProjectModalOpen: false,
                    isDevModeActive: false, 
                    isDevModeFull: false,   
                    
                    // Core Timeline/Canvas State
                    tracks: [
                        { id: 't1', name: 'Global', type: 'video', color: '#64748b' }, 
                        { id: 't2', name: 'Top', type: 'text', color: '#eab308' },
                        { id: 't3', name: 'Middle', type: 'video', color: '#22c55e' }, 
                        { id: 't4', name: 'Bottom', type: 'text', color: '#3b82f6' },
                        { id: 't5', name: 'BGM', type: 'audio', color: '#a855f7' }
                    ],
                    clips: [
                        { id: 'c1', trackId: 't1', name: 'Intro_BG.mp4', start: 0, duration: 10, type: 'video' },
                        { id: 'c3', trackId: 't5', name: 'BGM_Main.mp3', start: 0, duration: 30, type: 'audio' }
                    ],
                    canvasBoxes: [
                        { id: 'box_init', colIdx: 1, type: 'TXT', zIndex: 240, color: '#eab308', x: 1720, y: 980, w: 400, h: 200 }
                    ],
                    zoom: 20,
                    selectedClip: null,
                    selectedBoxId: null,
                    layerMainName: "",
                    layerTemplates: [],
                    isMagnet: true,
                    isAutoRipple: false,
                    isTimelineCollapsed: false,
                    currentTime: 0,
                    dragItemIndex: null, 
                    dragOverItemIndex: null, 
                    
                    // Preview Toolbar State
                    aspectRatio: '16:9',
                    resolution: '4K',
                    canvasSize: { w: 3840, h: 2160 }, 
                    mouseCoord: { x: 0, y: 0 }, 
                    isMouseOverCanvas: false,
                    canvasScale: 1.0, 
                    
                    // Inspector State
                    inspector: { tag: '', id: '', className: '', x: 0, y: 0, w: 0, h: 0, dataDev: '' },
                    highlightStyle: { width: '0', height: '0', top: '0', left: '0' },
                    tooltipStyle: { top: '0', left: '0' },
                    mouseMarkerPos: { x: 0, y: 0 },
                    layerCols: [
                        { id: 'c1', name: '전체', color: '#64748b' },
                        { id: 'c2', name: '상단', color: '#eab308' },
                        { id: 'c3', name: '중단', color: '#22c55e' },
                        { id: 'c4', name: '하단', color: '#3b82f6' }
                    ],
                    COLORS
                }
            },
            computed: {
                canvasScalerStyle() {
                    return {
                        width: this.canvasSize.w + 'px', 
                        height: this.canvasSize.h + 'px', 
                        backgroundColor: '#000', 
                        transform: `translate(-50%, -50%) scale(${this.canvasScale})`,
                        position: 'absolute', 
                        top: '50%', 
                        left: '50%'
                    }
                }
            },
            mounted() {
                this.$nextTick(() => { this.setupPanelResizers(); this.setupCanvasScaler(); this.setupInspectorMode(); });
                window.vm = this; 
            },
            methods: {
                // --- System & Dev Mode ---
                firePython(f) {
                    console.log('Py:', f);
                    if (window.backend && window.backend[f]) {
                        window.backend[f]();
                    } else {
                        console.log(`[DUMMY] Python call: ${f}`);
                    }
                },
                toggleDevMode(mode) {
                    if (mode === 'active') {
                        this.isDevModeActive = !this.isDevModeActive;
                        document.body.classList.toggle('dev-mode-active', this.isDevModeActive);
                        if (this.isDevModeActive) {
                            this.isDevModeFull = false;
                            document.body.classList.remove('dev-mode-full');
                        }
                    } else if (mode === 'full') {
                        this.isDevModeFull = !this.isDevModeFull;
                        document.body.classList.toggle('dev-mode-full', this.isDevModeFull);
                        if (this.isDevModeFull) {
                            this.isDevModeActive = false;
                            document.body.classList.remove('dev-mode-active');
                        }
                    }
                },
                addCol() { this.layerCols.push({ id: `lc_${Date.now()}`, name: 'New', color: '#333' }); },
                openCtx(e, id) { this.ctxMenu = { x: e.clientX, y: e.clientY, id }; },
                setColColor(c) { 
                    const col = this.layerCols.find(x => x.id === this.ctxMenu.id);
                    if(col) col.color = c;
                    this.ctxMenu = null;
                },
                setupInspectorMode() {
                    const self = this;
                    document.addEventListener('mousemove', (e) => {
                        if (!self.isDevModeActive) return;

                        let target = e.target;
                        if (target.classList.contains('dev-highlight') || target.classList.contains('dev-tooltip')) {
                             target = document.elementFromPoint(e.clientX, e.clientY);
                        }

                        if (target && target.tagName !== 'HTML' && target.tagName !== 'BODY') {
                            const rect = target.getBoundingClientRect();
                            
                            self.highlightStyle = {
                                width: `${rect.width}px`,
                                height: `${rect.height}px`,
                                top: `${rect.top}px`,
                                left: `${rect.left}px`,
                            };

                            let dataDevContent = target.getAttribute('data-dev') || '';
                            dataDevContent = dataDevContent.replace(/\\n/g, '\n');

                            self.inspector = {
                                tag: target.tagName,
                                id: target.id,
                                className: target.className,
                                x: Math.round(rect.left),
                                y: Math.round(rect.top),
                                w: Math.round(rect.width),
                                h: Math.round(rect.height),
                                dataDev: dataDevContent
                            };

                            self.tooltipStyle = {
                                top: `${rect.top - 50}px`, 
                                left: `${rect.left + rect.width + 10}px`,
                                transform: 'translateY(0)'
                            };

                            if (rect.top - 50 < 0) {
                                self.tooltipStyle.top = `${rect.bottom + 10}px`;
                            }
                        } else {
                            self.inspector = { tag: '', id: '', className: '', x: 0, y: 0, w: 0, h: 0, dataDev: '' };
                        }
                    });
                },

                // --- Preview/Canvas Logic ---
                setAspect(r) { 
                    this.aspectRatio = r; 
                },
                setResolution(r) { 
                    this.resolution = r; 
                },
                updateCanvasMouseCoord(e) {
                    const wrapper = document.getElementById('canvas-wrapper');
                    const scaler = document.getElementById('canvas-scaler');
                    if (!wrapper || !scaler) return;

                    const wrapperRect = wrapper.getBoundingClientRect();
                    const scalerRect = scaler.getBoundingClientRect();
                    
                    const padding = 20; 

                    const mouseX = e.clientX - wrapperRect.left - padding;
                    const mouseY = e.clientY - wrapperRect.top - padding;
                    
                    this.isMouseOverCanvas = mouseX > 0 && mouseY > 0 && mouseX < wrapperRect.width - padding && mouseY < wrapperRect.height - padding;
                    
                    this.mouseMarkerPos = { x: mouseX + padding, y: mouseY + padding };

                    const canvasX = e.clientX - scalerRect.left;
                    const canvasY = e.clientY - scalerRect.top;
                    
                    const scale = this.canvasScale;
                    const realX = canvasX / scale;
                    const realY = canvasY / scale;

                    this.mouseCoord = { 
                        x: Math.min(this.canvasSize.w, Math.max(0, realX)), 
                        y: Math.min(this.canvasSize.h, Math.max(0, realY))
                    };
                },
                
                // --- Layout Resizer Handlers ---
                setupPanelResizers() {
                    const setup = (rid, stateKey, minSize, dir, isReverse = false) => {
                        const r = document.getElementById(rid);
                        if (!r) return;
                        
                        let startS, startP;
                        const self = this;

                        const onMove = (ev) => {
                            const diff = (dir === 'w' ? ev.clientX : ev.clientY) - startP;
                            let newSize;
                            
                            if (dir === 'w') {
                                newSize = isReverse ? startS - diff : startS + diff;
                                self[stateKey] = Math.max(minSize, newSize);
                            } else { 
                                const headerHeight = 48; 
                                const targetHeight = ev.clientY - headerHeight - 2; 
                                
                                newSize = targetHeight;
                                const effectiveHeight = Math.max(minSize, newSize);

                                self.previewContainerHeight = `${effectiveHeight}px`;
                                self.timelineContainerHeight = `calc(100% - ${effectiveHeight}px)`;
                            }
                        };
                        
                        const onUp = () => {
                            document.removeEventListener('mousemove', onMove);
                            document.removeEventListener('mouseup', onUp);
                        };

                        r.addEventListener('mousedown', e => {
                            e.preventDefault(); 
                            // Get current size for calculation
                            startS = dir === 'w' ? self[stateKey] : 
                                     (rid === 'resizer-timeline' ? document.getElementById('preview-container').offsetHeight : 0);
                            startP = dir === 'w' ? e.clientX : e.clientY;

                            document.addEventListener('mousemove', onMove); 
                            document.addEventListener('mouseup', onUp);
                        });
                    };
                    
                    // Left Panel (Width)
                    setup('resizer-left', 'leftPanelWidth', 180, 'w', false);
                    
                    // Right Panel (Width - Reverse calculation)
                    setup('resizer-right', 'rightPanelWidth', 250, 'w', true); 
                    
                    // Center Horizontal (Height)
                    setup('resizer-timeline', 'previewContainerHeight', 100, 'h', false);
                },
                
                setupCanvasScaler() {
                    const wrapper = document.getElementById('canvas-wrapper');
                    
                    const updateScale = () => {
                        const padding = 20; 
                        const scale = Math.min((wrapper.clientWidth - padding)/this.canvasSize.w, (wrapper.clientHeight - padding)/this.canvasSize.h); 
                        this.canvasScale = scale;
                    };

                    updateScale();
                    new ResizeObserver(updateScale).observe(wrapper);
                },

                // --- Core Model Methods (Clips/Boxes) ---
                getZIndex(colIdx, type) {
                    const base = (colIdx * 100) + 100;
                    const offset = Z_INDEX_OFFSETS[type] || 60;
                    return base + offset;
                },
                addLayerBox(colIdx, type, color) {
                    const zIndex = this.getZIndex(colIdx, type);
                    const newBox = {
                        id: `box_${Date.now()}`, colIdx, type, zIndex, color,
                        x: 1920 - 200 + (colIdx*50), y: 1080 - 150 + (colIdx*50), w: 400, h: 300
                    };
                    this.canvasBoxes.push(newBox);
                },
                removeBox(id) {
                    this.canvasBoxes = this.canvasBoxes.filter(b => b.id !== id);
                    if (this.selectedBoxId === id) this.selectedBoxId = null;
                },
                setSelectedBoxId(id) {
                    this.selectedBoxId = (this.selectedBoxId === id) ? null : id;
                    this.selectedClip = null;
                },
                updateBoxPosition(id, dx, dy, dw, dh, isResizeEnd=false) {
                    const index = this.canvasBoxes.findIndex(b => b.id === id);
                    if (index === -1) return;

                    const box = this.canvasBoxes[index];
                    const newBoxes = [...this.canvasBoxes];
                    
                    newBoxes[index] = { 
                        ...box, 
                        x: box.x + dx, 
                        y: box.y + dy,
                        w: isResizeEnd ? dw : box.w,
                        h: isResizeEnd ? dh : box.h
                    };
                    this.canvasBoxes = newBoxes;
                },
                removeClip(id) {
                    this.clips = this.clips.filter(c => c.id !== id);
                },
                setSelectedClip(clip) {
                    this.selectedClip = (this.selectedClip && this.selectedClip.id === clip.id) ? null : clip;
                    this.selectedBoxId = null;
                },
                moveTrack(fromIndex, toIndex) {
                    const tracks = [...this.tracks];
                    const [removed] = tracks.splice(fromIndex, 1);
                    tracks.splice(toIndex, 0, removed);
                    this.tracks = tracks;
                },
                saveLayerTemplate(name) {
                    const newTpl = { id: `tpl_${Date.now()}`, name, cols: this.layerCols }; 
                    this.layerTemplates.push(newTpl);
                    this.layerMainName = name; 
                },
                addClipFromDrop(fileType, trackIndex, time, assetName) {
                    const trackId = this.tracks[trackIndex] ? this.tracks[trackIndex].id : null;
                    if (!trackId) return;
                    const newClip = {
                        id: `c_${Date.now()}`, trackId, name: assetName, 
                        start: time, duration: 10, type: fileType
                    };
                    this.clips.push(newClip);
                },
                updateClip(clipId, startChange, durationChange) {
                    const index = this.clips.findIndex(c => c.id === clipId);
                    if (index !== -1) {
                        const clip = this.clips[index];
                        const newClips = [...this.clips];
                        
                        const newStart = Math.max(0, clip.start + startChange); 
                        const newDuration = Math.max(0.1, clip.duration + durationChange - (newStart - clip.start));
                        
                        newClips[index] = {
                            ...clip,
                            start: newStart,
                            duration: newDuration
                        };
                        this.clips = newClips;
                    }
                },
                moveClip(clipId, timeChange) {
                    const index = this.clips.findIndex(c => c.id === clipId);
                    if (index !== -1) {
                        const clip = this.clips[index];
                        const newClips = [...this.clips];
                        newClips[index] = {
                            ...clip,
                            start: Math.max(0, clip.start + timeChange)
                        };
                        this.clips = newClips;
                    }
                }
            }
        };

        const app = createApp(App);
        app.mount('#vue-app');
    </script>
</body>
</html>